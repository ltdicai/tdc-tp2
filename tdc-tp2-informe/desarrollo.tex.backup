\section{Herramientas}

\subsection{Traceroute: idea}

Implementamos nuestra propia herramienta de traceroute siguiendo la técnica del envío de paquetes ICMP ECHO\_REQUEST/TIME\_EXCEEDED/ECHO\_REPLY. Consideramos dos posibles implementaciones: el algoritmo estandard, que consiste en enviar para cada TTL una ráfaga de paquetes; y una modificación en la que se envíe un paquete por TTL hasta alcanzar el host destino o superar el límite de saltos y repetir desde el principio. Elegimos la primera por simplicidad de la implementación al momento de calcular el valor del RTT.

Un punto a considerar cuando se realiza traceroute con ICMP es que cada paquete puede seguir una ruta distinta a la recorrida por los demás (y las rutas  pueden variar incluso entre la ida y la vuelta de un mismo paquete). Por lo tanto, para un TLL dado podríamos obtener respuestas de varios hosts distintos. Para lidiar con este problema, decidimos considerar solo la ruta más problable. Para esto, por cada rafaga de paquetes "echo request" consideramos como nodo del camino aquel que haya respondido la mayor cantidad de veces (al calcular la frecuencia descartamos los timetouts que hayan sucedido).

Existe otro detalle a resolver una vez que quedan determinados los host del camino: para cada host tenemos una muestra de RTTs que pueden  pueden variar considerablemente. Teniendo en cuenta el objetivo de nuestra herramienta es estimar un camino con los valores esperados de RTT entre nodos, sopesamos varias alternativas para aplanar los datos. Entre ellas analizamos las siguientes:
\begin{itemize}
\item{Menor RTT}
\item{RTT Promedio}
\item{RTT Promedio, quitando previamente los outliers de la muestra (con el método de Cimbala)}
\item{Mediana de RTT}
\end{itemize}
La herramienta calcula todas ella a modo de comparación, pero para los análisis nos decantamos por utilizar el RTT promedio pre-filtrado, pues esperamos que resulte en valores significativos que no se vean afectados por datos espurios. 


\subsection{Detección automática de enlaces de enlaces intercontinentales}

Una vez determinado un camino y los RTT correspondientes, estamos en condiciones de comenzar el análisis para intentar detectar automáticamente los enlaces intercontinentales de larga distancia basandonos en la técnica de estimación de outliers propuesta por Cimbala. Para ello, obtenemos los RTT relativos entre hops consecutivos y aplicamos el algoritmo de Cimbala a fin de detectar outliers. Nuestra hipótesis es que aquellos saltos que los saltos más altos que presenten outliers son posibles saltos intercontitentales. 

Resulta importante  considerar la posibilidad de que algunos hops no tengan definido su RTT. Esto puede suceder cuando, por ejemplo, el hop no implementaba ICMP o se encontraba detrás de un firewall que bloqueaba este protocolo. Contemplamos la opción de interpolar estos faltantes, pero concluimos que la falta de más información nos posibilita solo a aplicar un interpolado lineal que resultaría en información "suavizada" que juegue negativamente al momento de aplicar Cimbala. Por esto, decidimos utilizar solamente los hops con RTT definido: si detectamos un posible salto intercontinental y vemos que los hops no son consecutivos, al menos podemos deducir que el salto ocurre entre esos host. 


\subsection{Implementación}

La herramienta fue desarrollada en Python utilizando el paquete \texttt{scapy}, y permite definir los siguientes parametros de ejecución:
\begin{itemize}
	\item{MAT\_RAFAGA: tamaño de la ráfaga para cada TTL}
	\item{MAX\_TTL: cantidad máxima de saltos esperados}
	\item{TIMEOUT: tiempo de espera, medido en segundos }
	\item{P (Tolerancia a timeouts): cantidad de timeouts seguidos que se toleran antes de decidir que no hay respuesta, medido en porcentaje del tamaño de la ráfaga.}
	\item{OUTPUT: identificador para generar los nombres de los archivos de salida}
\end{itemize}

El código se divide en tres funciones principales
\begin{itemize}
	\item{\texttt{rastrear}: es la implementacion del algoritmo de traceroute utilizando paquetes ICMP. Devuelve un muestreo de RTTs por TTL.}
	\item{\texttt{generar\_camino}: a partir del muestreo devuelto por 'rastrear', decide cual es el camino más probable y calcula los RTT correspondientes a cada hop.}
	\item{\texttt{detectar\_enlaces\_intercontinentales}: dato un camino devuelto por \texttt{generar\_camino()}, calcula los RTT entre hops y marca aquellos que pueden ser saltos intercontinentales mediante la detección de outlier según el algoritmo de Cimbala.}
\end{itemize}	

Para el mapeo de IP a País utilizamos una base de datos obtenida de \href{http://www.maxmind.com}{MaxMind} actualizada al 09/07/2016, accedida en el código por medio del paquete \texttt{geoip2} de Python. Descartamos otras fuentes de datos que debido a que presentaban limitaciones de performance, no proveían una API o se encontraban desactualizadas. 


\section{Experimentos}
A fin de probar el comportamiento del algoritmo propuesto, recolectamos los resultados de ejecutar el programa tomando como destinos a cuatro universidades en distintos continentes. Realizamos 3 corridas para cada destino, variando el tamaño de la ráfaga en 50, 150 y 300 paquetes.
Las destinos elegidos fueron:

\begin{center}
   \begin{tabular}{ | c | c | c | c | }
     \hline
     \textbf{Universidad} & \textbf{Host} & \textbf{Pais} & \textbf{Contiente} \\ \hline
     Universidad de Oregon & \url{www.cs.uoregon.edu} & Estados Unidos & América del Norte\\ \hline
     universidad de Tokio & \url{www.u-tokyo.ac.jp} & Japón & Asia\\ \hline
     Universidad de Moscú & \url{msu.ru} & Rusia & Europa del Este\\ \hline
     universidad de Sudáfrica & \url{www.unisa.ac.za} & Sudáfrica & África \\ \hline
   \end{tabular}
 \end{center}
 
 
\begin{figure}[H]
  \centering
  \includegraphics[scale = 0.3]{imagenes/mapa.png}
  \caption{Ubicación de las universidades elegidas}
  \label{histogramaprobabilidadesModel1}
\end{figure}


Los experimentos se realizaron utilizando en una computadora con Linux Mint conectada a Internet (provisto por Fibertel) por medio de un enlace WiFi. Se utilizaron los siguientes comandos (donde $n$ es el tamaño de la ráfaga) 
\begin{table}[]
\centering
\caption{Saltos y sus RTT en el camino desde Buenos Aires a la Universidad de Sudáfrica (África).}
%\label{Universidad}
\begin{tabular}{ | c | c | l |}
	\hline 
Exp & Destino & Comando\\ \hline
 1 & Sudáfrica & \texttt{sudo python traceroute.py www.unisa.ac.za -tr n -p 0.3 -m 30 -o AFR\_n} \\ 
  2 & EEUU& \texttt{sudo python traceroute.py www.cs.uoregon.edu -tr n -p 0.3 -m 30 -o EEUU\_n} \\ 
  3 & Japon& \texttt{sudo python traceroute.py www.u-tokyo.ac.jp -tr n -p 0.3 -m 30 -o JAP\_n} \\ 
  4 & Rusia & \texttt{sudo python traceroute.py msu.ru -tr n -p 0.3 -m 30 -o RUSIA\_n} \\ 
  \hline

\end{tabular}
\end{table}
  Notar que la herramienta debe ejecutarse con permisos de \texttt{root}.
  

En las siguientes tablas mostramos los resultados obtenidos para distintos tamaños de ráfagas. Notar que solo estamos utilizando el RTT promedio previamente con outliers eliminados.


\subsection{Experimento 1: África}
\input{tablas/tabla_camino_africa}
\begin{landscape}
\input{tablas/tabla_saltos_africa}
\end{landscape}


\subsection{Experimento 2: Estados Unidos}
\input{tablas/tabla_camino_eeuu}
\begin{landscape}
\input{tablas/tabla_saltos_eeuu}
\end{landscape}


\subsection{Experimento 3: Japón}
\input{tablas/tabla_camino_japon}
\begin{landscape}
\input{tablas/tabla_saltos_japon}
\end{landscape}


\subsection{Experimento 4: Rusia}
\input{tablas/tabla_camino_rusia}
\begin{landscape}
\input{tablas/tabla_saltos_rusia}
\end{landscape}



	
\section{Análisis de resultados}

\section{Experimento 1: África}
\begin{figure}[H]
  \centering
  %\includegraphics[scale = 0.8]{imagenes/africaTTL.png}
  \caption{RTT estimado del traceroute a la Universidad de Sudafrica}
  \label{africaTTL}
  \subfigure[RTT promedio por TTL]{\includegraphics[scale = 0.8]{imagenes/africaTTL.png} }
  \subfigure[RTT relativos entre saltos]{\includegraphics[scale = 0.8]{imagenes/africaRTTrelativos.png}}
\end{figure}

\section{Experimento 2: Estados Unidos}

\begin{figure}[H]
  \centering
  %\includegraphics[scale = 0.8]{imagenes/eeuuTTL.png}
  \caption{RTT estimado del traceroute a la Universidad de Oregón }
  \label{eeuuTTL}
  \subfigure[RTT promedio por TTL]{\includegraphics[scale = 0.8]{imagenes/eeuuTTL.png} }
  \subfigure[RTT relativos entre saltos]{\includegraphics[scale = 0.8]{imagenes/eeuuRTTrelativos.png}}
\end{figure}


\section{Experimento 3: Japon}
\begin{figure}[H]
  \centering
  %\includegraphics[scale = 0.8]{imagenes/japonTTL.png}
  \caption{RTT promedio de traceroute a la Universidad de Tokio }
  \label{japonTTL}
  \subfigure[RTT promedio por TTL]{\includegraphics[scale = 0.8]{imagenes/japonTTL.png} }
  \subfigure[RTT relativos entre saltos]{\includegraphics[scale = 0.8]{imagenes/japonRTTrelativos.png}}
\end{figure}

\section{Experimento 4: Rusia}
\begin{figure}[H]
  \centering
  %\includegraphics[scale = 0.8]{imagenes/rusiaTTL.png}
  \caption{RTT promedio del traceroute a la Universidad de Moscú}
  \label{rusiaTTL}
  \subfigure[RTT promedio por TTL]{\includegraphics[scale = 0.8]{imagenes/japonTTL.png} }
  \subfigure[RTT relativos entre saltos]{\includegraphics[scale = 0.8]{imagenes/japonRTTrelativos.png}}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Segunda consigna: gráficos y análisis}



Realizaremos un análisis que permitará detectar los saltos correspondientes a enlaces intercontinentales. Para esto usaremos 

Para obtener los datos de los experimentos, consideramos lo siguiente:
Para calcular el RTT para un determinado Hop(salto) utilizamos un promedio de las muestras particulares para cada universidad.
Para usar el metodo de calculo de outlier, tomamos como hipotesis que los RTT relativos (entre hops) cuanto mas grande sean, mayor es la posibilidad de ser un salto intercontinental. Partiendo de esta base, llamamos al metodo de cimbala con el set de datos de RTT relativos.

\subsubsection{Experimentos}
\textbf{The university of tokio} \\

\textbf{Ruta de IPs:} \{ [192.168.10.1]; [200.89.160.17]; [200.89.165.222];
 [195.22.220.64]; [195.22.219.17]; [195.22.219.17]; [149.3.181.65]; [129.250.2.227]
 [129.250.4.13]; [129.250.2.54]; [129.250.3.86]; [129.250.6.188]; [129.250.2.255];
 [61.200.80.218]; [158.205.192.173]; [158.205.192.86]; [158.205.121.250];
 [154.34.240.254]; [210.152.135.178]\}

En el primer gráfico mostramos como incrementa el RTT a medida que se van enviando los paquetes con un TTL determinado. Se puede ver que cuando enviamos los paquetes con TTLs 2,3, y 4 no obtenemos respuesta, suponemos que hay servidores a dicha distancia no estan configurados para responder paquetes ICMP de tipo Echo Request,o que se perdieron en la red. Tambien, como habiamos dicho antes, suponemos que los saltos de incremento del RTT se debe a una conexión intercontinetal, asi que podemos asumir que hay posible conexiones ente los Hops 1-2, 9-10, 13-14 y 15-16.
Para comprobar esta hipotesis, tomamos el RTT relativo entre Hops y se los pasamos al metodo de cimbala y nos da como resultado que los posibles candidatos son:
(9, 5, 7, 11)


\begin{center}
   \begin{tabular}{ |l | c | r | }
     \hline
     \textbf{Origen} & \textbf{Destino} & \textbf{RRT relativo (ms)} \\ \hline
     Home & Argentina & 20.868 \\ \hline
     Argentina & Argentina & 0.162 \\ \hline
     Argentina & Italy & 3.043 \\ \hline
     Italy & Italy & 30.260 \\ \hline
     Italy & Italy & 8.189 \\ \hline
     Italy & Italy & 109.476\\ \hline
     Italy & United States & 1.993\\ \hline
     United States & United States & 52.135 \\ \hline
     United States & United States & 0.485\\ \hline
     United States & United States & 111.830\\ \hline
     United States & United States & 1.617 \\ \hline
     United States & United States & 48.441 \\ \hline
     United States & Japan & 32.720 \\ \hline
     Japan & Japan & 10.492 \\ \hline
     Japan & Japan & 4.534 \\ \hline
     Japan & Japan & 26.721 \\ \hline
     Japan & Japan & 7.028 \\ \hline
     Japan & Japan & 19.043 \\ \hline
   \end{tabular}
 \end{center}
